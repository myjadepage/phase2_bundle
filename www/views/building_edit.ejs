<%- include('inc/head',{title:'phase2'}) %>
    <%- include('inc/sidebar',{title:'phase2', date:new Date}) %>
        <%- include('inc/nav',{date:new Date}) %>

            <div class="content">
                <div class="">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-h2">
                                <div class="card-header">
                                    <h5 class="card-title">빌딩 정보 수정</h5>
                                </div>
                                <div class="card-body">
                                    <form>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label>빌딩 이름 수정</label>
                                                    <input type="text" class="form-control"  name="b_name" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="row form-group">
                                                    <div class="col-md-12">
                                                        <label>빌딩 타입 수정</label>
                                                        <select class="form-control" name="buildingtype"></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card  card-h2">
                                <div class="card-header">
                                    <h5 class="card-title">공용도어 정보 입력</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-full-width">
                                        <table class="table" id="commonDoor">
                                            <colgroup>
                                                <col width="10%">
                                                <col width="*">
                                                <col width="25%">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th colspan="2">
                                                        <div class="form-check">
                                                            <label class="form-check-label" style="line-height: 20px;">
                                                                            <input class="form-check-input" type="checkbox" value="">
                                                                            <span class="form-check-sign"></span>                                                                            
                                                                        </label>
                                                            <span>1 selected</span>
                                                            <button role="button" data-toggle="modal" data-target="#Delproperty" class="btn btn-simple btn-link">
                                                                                <i class="icon trash"></i>
                                                                        </button>
                                                        </div>
                                                    </th>
                                                    <th class="text-right">total: <strong class="text-primary" id="doorCnt"></strong></th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer ">
                                    <hr>
                                    <div class="state form-inline">
                                        <input type="text" class="form-control" placeholder="공용도어 이름 입력">
                                        <a role="button" data-toggle="modal" data-target="#propertyDone" class="btn btn-primary">공용도어 추가</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <button type="reset" class="btn btn-default btn-fill shadow pull-left" onclick="location='javascript:history.back()'">뒤로가기</button>
                            <button type="button" id="btnEditBuilding" class="btn btn-primary  btn-fill pull-right shadow">빌딩 정보 수정</button>
                        </div>
                    </div>
                </div>
            </div>

            <%- include inc/footer %>
                <%- include inc/modal %>
                    <%- include inc/bottom %>

                        <script>
                            //navTitle 쿼리 
                            var name;
                            var address;
                            var itemQuery;
                            qs();
                            $('.nav .query_building').attr('href', '/properties/<%= id %>/building' + itemQuery);
                            $('.nav .query_doorlock').attr('href', '/properties/<%= id %>/doorlock' + itemQuery);
                            $('.nav .query_issuekey').attr('href', '/properties/<%= id %>/issuekey' + itemQuery);
                            $('.nav .query_staff').attr('href', '/properties/<%= id %>/staff' + itemQuery);
                            $('.nav .query_report').attr('href', '/properties/<%= id %>/report' + itemQuery);
                            navTitle(name, address);



                            var API_KEY = localStorage.getItem('api_key');
                            var id = "<%= id %>";
                            var bid = "<%= bid %>";
                            var url = "properties/" + id + "/buildings/" + bid;


                            // 빌딩타입 불러오기    
                            var url2 = "properties/" + id + "/buildingtypes"
                            $.ajax({
                                    method: "get",
                                    url: endUrl(url2),
                                    contentType: "application/json; charset=utf-8",
                                    headers: headers(),
                                    data: {
                                        property_id: id,
                                        language_code: "ko"
                                    }
                                })
                                .done(function(res) {
                                    console.log(res);
                                    $('select[name="buildingtype"]').empty();
                                    $('select[name="buildingtype"]').append('<option  value="0" value="0" selected="true">빌딩 타입 선택</option>');
                                    $('select[name="buildingtype"]').prop('selectedIndex', 0);
                                    for (var i of res.items) {
                                        $('select[name="buildingtype"]').append($('<option></option>').attr('value', i.id).text(i.name));
                                    }
                                })
                                .fail(function(request, status, error) {
                                    msg = request.status + "<br>" + request.responseText + "<br>" + error;
                                    console.log(msg);
                                    alert("빌딩타입을 불러 올 수 없습니다.");
                                })

                            //빌딩상세 api

                            $.ajax({
                                    method: "get",
                                    url: endUrl(url),
                                    contentType: "application/json; charset=utf-8",
                                    headers: headers()
                                })
                                .done(function(res) {
                                    console.log(res);
                                    $('[name="b_name"]').val(res.name);
                                    $('[name="buildingtype"').val(res.buildingtype);
                                    for (var i in res.commonrooms) {
                                        var id = res.commonrooms[i].id;
                                        var name = res.commonrooms[i].name;
                                        var rowItem = '<tr><td>' + name + '</td>tr>';
                                        $('#commonDoor tbody').append(rowItem);
                                    }
                                })
                                .fail(function(request, status, error) {
                                    msg = request.status + "<br>" + request.responseText + "<br>" + error;
                                    console.log(msg);
                                    alert("빌딩내용을 불러 올 수 없습니다.");
                                })


                            $('#btnEditBuilding').on('click', function() {
                                var name = $('input[name="name"]').val();
                                var buildingtype_id = $('select[name="buildingtype"] option:selected').val();
                                if (name == "") {
                                    alert("빌딩이름을 입력해 주세요");
                                } else if (buildingtype_id == "0") {
                                    alert("빌딩타입을 선택해 주세요");
                                }
                                //입력박스 체크 뒤 api 호출 
                                var params = {};
                                if (!(name == "")) {
                                    params.name = name;
                                }
                                if (!(buildingtype_id == "0")) {
                                    params.buildingtype_id = buildingtype_id;
                                }
                                console.log(JSON.stringify(params));
                                $.ajax({
                                        url: endUrl(url),
                                        contentType: "application/json; charset=utf-8",
                                        type: 'put',
                                        headers: headers(),
                                        data: JSON.stringify(params)
                                    })
                                    .done(function(res) {
                                        console.log(res);
                                        $('#editBuuildingDone').modal('show');
                                        location.href = '/properties/' + id + '/building' + itemQuery;
                                    })
                                    .fail(function(jqXHR, textStatus, errorThrown) {
                                        console.log('Error: ' + textStatus + ' - ' + errorThrown);
                                    })

                            });
                        </script>